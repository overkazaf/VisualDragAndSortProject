/**
 * 
 * @authors John Nong (overkazaf@gmail.com)
 * @date    2015-04-17 17:15:40
 * @version $Id$
 */
	// A tiny seed id generator
	var generatorId = function (len, radix, prefix, subfix){
		var targetId = '';
	    var chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'.split('');
	    var uuid = [], i;
	    len = len || 32;
			radix = radix || chars.length;
			prefix = prefix || '';
			prefix = prefix == '' ? '' : prefix + '_';
			subfix = subfix || '';
			subfix = subfix == '' ? '' : '_' + subfix;
	 
	    if (len) {
	      // Compact form
	      for (i = 0; i < len; i++) uuid[i] = chars[0 | Math.random()*radix];
	    } else {
	      // rfc4122, version 4 form
	      var r;
	 
	      // rfc4122 requires these characters
	      uuid[8] = uuid[13] = uuid[18] = uuid[23] = '-';
	      uuid[14] = '4';
	 
	      // Fill in random data.  At i==19 set the high bits of clock sequence as
	      // per rfc4122, sec. 4.1.5
	      for (i = 0; i < 36; i++) {
	        if (!uuid[i]) {
	          r = 0 | Math.random()*16;
	          uuid[i] = chars[(i == 19) ? (r & 0x3) | 0x8 : r];
	        }
	      }
	    }
	 
	  		targetId = uuid.join('');
			return prefix+targetId+subfix;
		};
	/**
	 * [initModules description]
	 * @param  {[type]} entry [If not null, redicect to a existed template that has been already generated]
	 * @return {[type]}       [description]
	 */
	function initModules( entry ){
	    var callbacks = $.Callbacks();
		if (entry && entry != '') {
			$.ajax({
				url : entry,
				type : "GET",
				dataType : "html",
				success : function (data){
					$('#main-wrapper').replaceWith(data);
				}
			}).done(function (){
			    callbacks.add(initHeader);
			    callbacks.add(initMainWrapper);
			    callbacks.add(initDragWidgets);
			    callbacks.add(initDragLayouts);
			    callbacks.add(preloadCachedData);
			    callbacks.fire();
			});
		} else {
		    callbacks.add(initHeader);
            callbacks.add(initMainWrapper);
            callbacks.add(initDragWidgets);
            callbacks.add(initDragLayouts);
            callbacks.fire();
		}
	}

	function initHeader(callback){
		var oHeader = $('.header');
		var oTool = oHeader.find('.tool-part');
		var oToolMenu = oTool.find('ul.tool-menu');
		var oTooleMenuContainers = oTool.find("div.tool-container");

		initPublish();
		oToolMenu.on('click', 'li', function (index,value){
		    if ($(this).index() == 1) {
		        var cache = $(document).data('cachedWrapper');
		        if (cache){
		            // backto edit mode
		            $('.wrapper').replaceWith(cache);
		            //rebind functions
		            $('.wrapper').find('*[operable]').each(function (){
		                $(this).smartMenu(menuData);
		            });
		            var $cb = $.Callbacks();
		            $cb.add(resetDragWidgets);
		            $cb.add(initDragLayouts);
		            var fnClean = function (){
		                $('#dragged-list').dragsort('destroy');
	                    $('#dragged-list').dragsort();
	                    $(document).removeData('cachedWrapper');
		            };
		            $cb.add(fnClean);
		            $cb.fire();
		        }
		    }
			if ($(this).hasClass('selected')) {
				$(this).removeClass('selected');
				$('.toggle-container').hide().animate({height : 0}, 'slow', 'swing');
				//$(window).scrollTop(0);
				$('.wrapper').animate({
					'margin':'100px auto'
				}, 400, 'swing');
			} else {
				var index = $(this).index();
				$(this).addClass('selected').siblings().removeClass('selected');
				$('.toggle-container').show().animate({height : '190px'}, 'slow', 'swing');
				$('.wrapper').animate({
					'margin':'300px auto'
				}, 500);
				oTooleMenuContainers.hide().eq(index).fadeIn('slow');
			}
			
			
		});
		//oToolMenuItems.eq(0).trigger('click');
		oTooleMenuContainers.hide();
		$('.toggle-container').hide().animate({height : 0});
		$('.wrapper').animate({'margin':'100px auto'},400);
		

		var callbacks = $.Callbacks();
		// Init Layout Element
		callbacks.add(initLayout);
		// Init radio btns
		callbacks.add(initWidgetRadioButton);
		// Init Theme Elemnet
		callbacks.add(initTheme);
		// Init Background Menu
		callbacks.add(initBackground);
		// Enable modal draggable
		callbacks.add(function(){
		    $('#configModal').dragModal();
		});
		// Enable tool part to be slidable
		callbacks.add(initSlider);
		callbacks.fire();
		
		if (callback && $.isFunction(callback)) {
		    callback();
		}
	}

	/**
     * [initSlider description]
     * @return {[type]} [description]
     *
     * comment : 
     *          Use slider to prevent conetent overflow
     */
	function initSlider(){
	    var aLi = $('#widget-tab').find('ul.widget-items-tab').children('li');
	    var l = aLi.length;
        if (l) {
            aLi.each(function (){
                $(this).css({
                    width: 980/6 + 'px'
                });
            });
            var opt1 = {
                'slider'       : '#widget-tab',
                movedItemClass : '.widget-items-tab',
                previousButton : 'a.prev',
                nextButton     : 'a.next',
                hasSmallButton : !1,
                "width"        : 980,
                itemsPerPage   : 6
            };
            
            $("#widget-tab").johnSlidable(opt1);
        }
        
        
	    $(".widget-content-slider").each(function (index){
	        var opt2 = {
                "slider" : ".widget-content-slider:eq(" + index +")",
                "movedItemClass" : 'ul.widget-list',
                "previousButton" : 'a.prev',
                "nextButton"     : 'a.next',
                "width"          : 980,
                hasSmallButton : !1,
                itemsPerPage   : 5
	        };
	        $(this).johnSlidable(opt2);
	    });
	    
	    var opt3 = {
            "slider" : ".theme-content-slider",
            "movedItemClass" : 'ul.theme-list',
            "previousButton" : 'a.prev',
            "nextButton"     : 'a.next',
            "width"          : 980,
            hasSmallButton   : !1,
            itemsPerPage     : 5
        };
	    $(".theme-content-slider").johnSlidable(opt3);
	}
	
	/**
	 * [initLayout description]
	 * @return {[type]} [description]
	 *
	 * comment : 
	 * 			Binding click events in layout part
	 */
	function initLayout(){
		//init layout events
//		var layoutList = $('.header').find('ul.layout-list');
//		layoutList.find('li').each(function (){
//		    $(this).on('click', function (){
//	            var template = $(this).attr('data-layout-template');
//	            var html = buildDraggableLayout(template);
//
//	            var oDrag = $('<li class="drag-part" data-source-code="layout"></li>');
//	            var $dom = $(html);
//	            var layoutId = generatorId(null, null, 'Layout', 'Generated');
//	            $dom.attr('id', layoutId).attr('data-layout-id', layoutId);
//	            oDrag.append($dom);
//	            //oDrag.smartMenu(menuData);
//	            $('#dragged-list').append(oDrag);
//	            oDrag.find('*[operable]').smartMenu(menuData);
//	            oDrag.find('*[data-type=layout-template]').smartMenu(menuData);
//	        });
//		});
	}

	function initTheme(){
		var themeList = $('.theme-list');

		//Theme items use event delegation
		if (themeList.length) {
			themeList.on('click', 'li', function (){
			    // Append a status flag to themeList
	            if (!$(document).data('cachedWrapper')){
	                $(document).data('cachedWrapper', $('.wrapper').clone());
	            }
			    var url = $(this).data('theme-template');
			    var themeType = url.indexOf("isModel=1") >= 0 ? 'code' : 'drag';
				$.ajax({
				    cache : false,
				    async : true,
				    url : url,
				    type : "GET",
				    dataType : "html",
				    success : function (data){
				        var oWrapper = $('#main-wrapper');
				    	$('#dragged-list').dragsort('destroy');
				    	oWrapper.empty().html(data);
				    	oWrapper.find('.layout-template').each(function (){
		                    $(this).smartMenu(menuData);
		                });
				    	oWrapper.find('*[operable]').each(function (){
		                    $(this).smartMenu(menuData);
		                });
		                $('#dragged-list').dragsort();
		                resetDragWidgets();
				    }
				});
			});
		}

		//This will get all the generated themes that have already been published
//		$.ajax({
//			url : "scan.php",
//			cache : false,
//			type : "GET",
//			dataType : "JSON",
//			success : function (d){
//				if (d['success'] == true) {
//					var fragment = '';
//					var data = d['data'];
//					$.each(data, function (i){
//						var shortName = this.substring(0,this.indexOf('.html'));
//						fragment += '<li class="theme-list-item" data-theme-template="'+shortName+'">主题'+(i)+'</li>';
//					});
//					themeList.html(fragment);
//				}
//			}
//		});
	}

	function initBackground () {
	    $('#rgb_diy').ColorPicker({
            onSubmit : function(hsb, hex, rgb, el) {
                $(el).val(hex);
                $(el).ColorPickerHide();
            },
            onBeforeShow : function() {
                $(this).ColorPickerSetColor(this.value);
            }
        }).on('keyup', function() {
            $(this).ColorPickerSetColor(this.value);
        });
	    
	    if ($("#bgUpload").length) {
	        try{
	            $("#bgUpload").uploadify('destroy');
	        }catch(e){};
	    }
	    
        $("#bgUpload").uploadify({
            height          : 30,
            width           : 200,
            buttonText      :'<div class="row-fluid"><button class="btn btn-block btn-primary">选择图片</button></div>',
            swf             : ctxUrl+'/cmskj/js/uploadify/uploadify.swf',
            uploader        : ctxUrl+'/attachmentController/uploadReturnUrl.do?type=1',
            'removeCompleted' : false,
            'onUploadSuccess' : function(file, data, response) {
                //alert('The file ' + file.name + ' was successfully uploaded with a response of ' + response + ':' + data);
                var res = $.parseJSON(data);
                if (res.success === true) {
                    $('#bg-url').val(res.url);
                }
            }
        });
        
        $('#clearBg').on('click', function (){
        	var bgi = '';
        	$('#bg-url').val('');
        	$('.wrapper').css("background-image", "url(/" + bgi + ")");
        });
        
        $('.dropdown-menu').on('click', 'li' ,function (){
           var txt = $(this).children('a').text();
           var btn = $(this).closest('.btn-group').children('button');
           log(btn.html(txt + "  <span class='caret'></span>"));
           //.text(txt);
        });

        $('#confirm-bg-btn').on('click', function (){
            var oWrapper = $('.wrapper');
            var ctx = $('.tool-container').filter('.background-container');
            
            var a = [];
            var aInps = ctx.find('input');
            aInps.each(function (){
                var val = $(this).val();
                a.push(val);
            });
            var bgc = a[0],
                bgw = a[1],
                bgi = a[2],
                position_x = a[3],
                position_y = a[4];
            bgi = $('#bg-url').val();
            var oRepeat = ctx.find('button.dropdown-toggle');
            var m = $.trim($(oRepeat).text());
            var repeat = 'no-repeat';
            if (m !== '') {
                if (m === 'Y-重复') {
                    repeat = 'repeat-y';
                } else if (m === 'X-重复') {
                    repeat = 'repeat-x';
                } else if (m === '重复') {
                    repeat = 'repeat';
                } else if (m === '不重复') {
                    repeat = 'no-repeat';
                }
            }
            
            bgc != '' && oWrapper.css("background-color", (bgc == 'transparent' ? bgc : '#'+bgc));
            
            if(bgw){
                var oW = oWrapper.width();
                var testWidth = (parseInt(bgw) / 100)*oW;
                if (testWidth < 960) {
                    alert('默认布局最小宽度为960px,请重新设置比例');
                    aInps[1].value = '100%';
                    aInps[1].focus();
                } else if (testWidth > 1920){
                    alert('默认布局最大宽度为1920px,请重新设置比例');
                    aInps[1].value = '100%';
                    aInps[1].focus();
                } else {
                    globalWidth = bgw;
                    oWrapper.css("width", bgw);
                }
            }
            
            if (bgi) {
                oWrapper.css("background-image", "url(/" + bgi + ")");
                if (position_x && position_y) {
                    oWrapper.css("background-position", position_x + " " + position_y);
                }
                oWrapper.css("background-repeat", repeat);
            }
            
        });
    }
	
	function initWrapperDraggable(){
		var oWrapper = $('.wrapper');
		var aOperable = oWrapper.find('*[operable]');
		aOperable.each(function (){
			var operType = $(this).attr('operable');
			if (operType) {
			    if (operType.indexOf('layout') >= 0) {
	                $(this).smartMenu(menuData);
	            } else {
	                if (operType.indexOf('text,href') >= 0) {
	                    $(this).smartMenu(menuData);
	                } else if($(this).attr('id') && operType == 'navbar-list'){
	                    $(this).smartMenu(menuData);
	                    $(this).find('*[operable]').each(function (){
                            $(this).smartMenu(menuData);
                        });
	                    var parentUl = $(this).children('ul.nav-list');
	                    var aLi = parentUl.children('.nav-list-item');
	                    aLi.smartMenu(menuData);
	                }
	            }
			}
		});
		
		var aDraggableWidgets = $('.wrapper').find('div[class^=widget]');
		aDraggableWidgets.each(function (){
		    $(this).johnDraggable(draggableData);
		});
	}

	window.widgetCachedData = {};
	window.layoutCachedData = {};
	window.globalWidth = '';
	function preloadCachedData () {
		var oWrapper = $('#main-wrapper');
		// for width
		//widgets
		oWrapper.find('div[class^=widget-]').each(function (){
			var _this = $(this);
			if (_this.attr('data-cache')) {
				var cache = _this.attr('data-cache'),
				    cachedObj = $.parseJSON(cache),
					widget = cachedObj['id'];
				widgetCachedData[widget] = cachedObj['data'];
			}
		});
		
		//layouts
		oWrapper.find('div[class^=layout-container]').each(function (){
			var _this = $(this);
			if (_this.attr('data-cache')) {
				var cache = _this.attr('data-cache'),
				    cachedObj = $.parseJSON(cache),
					layout = cachedObj['id'];
				layoutCachedData[layout] = cachedObj['data'];
			}
		});
	}
	
	var hasJQ = !1,
	    jsInjected = !1,
	    hasPPT = !1,
	    hasShortcutPPT = !1,
	    hasVOTE = !1,
	    hasMultiNav = !1,
	    hasTPSlider = !1;
	function doPublish(originHTML){
	    //step1. Directlly return editable wrapper html
		$.ajax({
			url : ctxUrl + "/modelController/saveHtml.do",
            data : {"html" : originHTML,"ftlIstheme" : "2"},
			type : "POST",
			dataType : "text",
			success : function (html){
			    alert('发布成功');
			    $('#dragged-list').dragsort("destroy");
			    var returnValue = [];
			    
			    var oMainWrapper = $('#main-wrapper');
			    var oWrapper = oMainWrapper.css({
			    	'position' : 'relative',
			    	'width' : '100%',
	                'margin' : "0 auto",
	                'height' : '1000px',
	                'min-height' : '200px',
	                'min-width' : '960px',
	                'background-size' : '100% 100%',
	                'background-image' : oMainWrapper.css('backgroundImage')
	            });

			    oWrapper.find('.widgetHighLight').length && oWrapper.find('.widgetHighLight').removeClass('widgetHighLight');
			    oWrapper.find('.highlight').length && oWrapper.find('.highlight').removeClass('highlight');
			    var tick = generatePreviewHTML(originHTML);
	            var targetHTML = oWrapper.html(tick).prop('outerHTML');
	            var appendScripts = '';
	            if (hasJQ) {
	                appendScripts += '<script type="text/javascript" src="' + absUrl + '/cmskj/js/drag/jquery-1.11.1.min.js" ><\/script>';
	            }
	            
	            if (hasMultiNav) {
	                appendScripts += '<script type="text/javascript" src="' + absUrl + '/cmskj/js/multiNav.js" ><\/script>';
	            }
	            
	            if (jsInjected) {
	                appendScripts += '<script type="text/javascript" src="' + absUrl + '/cmskj/injectedJS.js" ><\/script>';
	            }
	            
	            if (hasPPT) {
	                appendScripts += '<script type="text/javascript" src="' + absUrl + '/cmskj/js/drag/jquery-johnSlidable.js" ><\/script>';
	                appendScripts += '<script type="text/javascript" src="' + absUrl + '/cmskj/js/sliderJS.js" ><\/script>';
	            }
	            
	            if (hasShortcutPPT) {
                    appendScripts += '<script type="text/javascript" src="' + absUrl + '/cmskj/js/drag/jquery-multiSlider.js" ><\/script>';
                    appendScripts += '<script type="text/javascript" src="' + absUrl + '/cmskj/js/sliderShortcutJS.js" ><\/script>';
                }
	            
	            
	            if (hasVOTE) {
                    appendScripts += '<script type="text/javascript" src="' + absUrl + '/js/jquery.form.js" ><\/script>';
                    appendScripts += '<script type="text/javascript" src="' + absUrl + '/cmskj/js/voteJS.js" ><\/script>';
                }
	            
	            if (hasTPSlider) {
                    appendScripts += '<script type="text/javascript" src="' + absUrl + '/cmskj/js/tpSlider.js" ><\/script>';
                }
//	            //step2.
//		        var htmlShow = cleanHTMLTags(targetHTML);
//
//		        //step3.
//		        var htmlCleaned = cleanHTMLTags(targetHTML);
	            var tarHTML = targetHTML ? targetHTML : '';
	            targetHTML = '<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>' + tarHTML + '</body>'+appendScripts+'</html>';
		        returnValue.push(targetHTML);
		        returnValue.push($('#ftlName').val());
		        returnValue.push(targetHTML);
		        window.returnValue = returnValue;
		        window.close();
			}
		});
		//step1. Directlly return editable wrapper html
		// $.ajax({
		// 	url : url,
		// 	type : "POST",
		// 	data : {},
		// 	success : function (){
		// 		var returnValue = [];
		// 		//step2.
		// 		var htmlShow = cleanHTMLTags(html);

		// 		//step3.
		// 		var htmlCleaned = cleanHTMLTags(html);


		// 		returnValue.push(htmlShow);
		// 		returnValue.push(htmlCleaned);

		// 		window.returnValue = returnValue;
		// 	}
		// });
	}

	/**
	 * [cleanHTMLTags description]
	 * @param  {[type]}
	 * @return {[HTML string]} 
	 *
	 * comment : Replace '<' and '>' flag so can review source code in previous edit panel
	 */
	function cleanHTMLTags (html){
		while (html.indexOf('<') != -1){
			html = html.replace('<', '[[');
		}
		while (html.indexOf('>') != -1){
			html = html.replace('>', ']]');
		}
		return html;
	}

	/**
	 * [generatePreviewHTML description]
	 * @param  {[type]} html [description]
	 * @return {[type]}      [Return a preview HTML, need to packed and unpacked some codes]
	 */
	function generatePreviewHTML(html){
		var $dom = $(html);
		var extScripts = $dom.find('script');
		var extLinks = $dom.find('link');
		
		//======================================================================================
		//  There are some cases should be well handled
		//  
		//  Case 1: Prepend base.css file into the wrapper header
		//  Case 2: Flash plugins should do some reconstruction and resize jobs
		//  Case 3: Include jQuery library if needed
		//  Case 4: Append injected JS scripts at the bottom
		//  Case 5: Append slider JS scripts at the bottom
		//  Case 6: Wrap the img element when it has 'link' attribute in data-history config
		//  Case 7: Replace the 'contentShow' area of 'desc_ext' area
		//  Case 8: Replace the 'vote-body' area of vote template
		//=======================================================================================
		
	    //  Case 0: Prepend charset into the wrapper header
		//$('<meta charset="GB2312">').prependTo($dom);
		//  Case 1: Prepend base.css file into the wrapper header
		$('<link>',{
			type : "text/css",
			href : absUrl + "/cmskj/css/base.css"
		}).prependTo($dom);
		
		//  Case 2: Widget should do some reconstruction handles
		var aOperables = $dom.find('*[operable]');
		aOperables.each(function (){
			var o = $(this).attr('operable');
			var oArray = o.split(',');

			if (oArray.length == 1) {
				var operType = oArray[0];
				if (operType == 'flash') {
					var	iW = 200,
						iH = 80,
						sLink = '',
						flashId = '',
						flashHTML = '',
						configString = $(this).attr('data-history-config');


					if (configString) {
						var config = parseKV2Json(configString);
						for (var attr in config) {
							if (attr == 'width') {
								iW = config[attr];
							} else if (attr == 'height'){
								iH = config[attr];
							} else if (attr == 'link') {
								sLink = config[attr];
								var url = new String(sLink);
								flashId = url.substring(0, url.lastIndexOf('.'));
							}
						}
					}
					flashHTML += '<object width="' + iW + '" height="' + iH + '" type="application/x-shockwave-flash" ';
					flashHTML += 'data="/' + sLink + '" id="flash_' + flashId + '" style="visibility:visible;">';
					flashHTML += '<param name="movie" value="/'+ sLink +'" />';
					flashHTML += '<param name="allowScriptAccess" value="always" />';
					flashHTML += '<param name="wmode" value="transparent" />';
					flashHTML += '<param name="allowFullscreen" value="true" />';
					flashHTML += '<param name="quality" value="high" />';
					flashHTML += '</object>';
					$(this).replaceWith(flashHTML);
				} else if (operType == 'upload') {
					// For pictures
					var configString = $(this).attr('data-history-config');
					if (configString) {
						var config = parseKV2Json(configString);
						for (var attr in config) {
                            if (attr == 'width') {
                                iW = config[attr];
                            } else if (attr == 'height'){
                                iH = config[attr];
                            } else if (attr == 'link') {
                                sLink = config[attr];
                            }
                        }
						
						// Case 6: Wrap the img element when it has 'link' attribute in data-history config
						//wrapp the image with a link
						$(this).css({
						    'width' : iW + "!important;",
						    'height' : iH + "!importaint;"
						});
                        var oldHtml = $(this).prop('outerHTML');
                        var oA = '<a href="'+sLink+'" title="图片链接">' + oldHtml + '</a>';
                        $(this).replaceWith(oA);
					}
				}
			}
			
		});

		var aDependencies = $dom.find('*[data-widget-dependency]');
		aDependencies.each(function (){
			var d = $(this).data('widget-dependency').toLowerCase();
			//  Case 3: Include jQuery library if needed
			if(d.indexOf('hasjq') >= 0){
				hasJQ = true;
			}
			
			if(d.indexOf('multi-nav') >= 0){
                hasMultiNav = true;
                var aUl = $(this).find('ul.nav-list[data-level=1]');
                aUl.each(function (index){
                    var item = $(this).children('li');
                    if (item.length){
                        if (item.length == 1) {
                            $(this).remove();
                        } else {
                            $(this).children('li:first').remove();
                        }
                    }
                });
            }
			
			//  Case 4: will Append injected JS scripts at the bottom
			if (d.indexOf('jsinjected') >= 0) {
			    jsInjected = true;
			}
			
			//  Case 5: mark the ppt flag
			if (d.indexOf('ppt') >= 0) {
                hasPPT = true;
            }
			
			if (d.indexOf('multi-ppt') >= 0) {
                hasShortcutPPT = true;
            }
			
			if (d.indexOf('vote') >= 0){
                hasVOTE = true;
            }
			
			if (d.indexOf('tp-slider') >= 0) {
			    hasTPSlider = true;
			}
		});
		
		var contentSource = $dom.find('*[desc_ext]'),
			contentSourceArray = [],
			contentShowArray = [];

		contentSource.each(function (){
			var content = $(this).attr('desc_ext');
			var ctShow = $(this).find('[desc=contentShow]');
			contentShowArray.push(ctShow.html());
			contentSourceArray.push(content);
			$(this).removeAttr('desc_ext');
		});



		// Construct a brand new template
		var aTemplates = $dom.find('.layout-template');
		aTemplates.each(function (){
			$(this).removeAttr('style')
			       .removeAttr('class')
			       .removeAttr('data-type');
			//destroy data info
			//$(this).removeAttr('data-*');
		});
		
		//  Case 7: Replace the 'contentShow' area of 'desc_ext' area
		$dom.find('[desc=contentShow]').each(function (index){
			var rep = contentSourceArray[index];
			if (rep) {
				rep = rep.replace(/^\S@([A-Z]+)\S|\S#([A-Z]+)\S/g, function(m){return m.toLowerCase();});
			}
			$(this).text(rep);
		    $(this).removeAttr('desc');
		});
		
        //  Case 8: Replace the 'vote-body' area of vote template
		var aVotes = $dom.find('[operable=vote]');
		aVotes.each(function (){
//		    var vBody = $(this).find('.vote-body');
//		    var template = buildVoteTemplate(CACHE.VOTE);
//		    vBody.html(template);
		});
		
		
		var aOperables = $dom.find('*[operable]');
		aOperables.each(function (){
		    //.removeAttr('id')
            //.removeAttr('data-widget-id')  
		    $(this).removeAttr('data-layout-id')
		             .removeAttr('data-layout-param')
		             .removeAttr('data-history-config')
		             .removeAttr('operable');
		});

		// Need to do the clean job after tackle all the corner cases
		var aDecorates = $dom.find('.layout-decoration');
		aDecorates.each(function (){
			var aHL = $(this).find('.highlight'),
				aWHL = $(this).find('.widgetHighLight');
			if (aHL.length){
				aHL.removeClass('highlight');
			}
			
			if (aWHL.length){
				aWHL.removeClass('widgetHighLight');
			}
		    $(this).removeClass('layout-decoration');
		});
		
		var aLayers = $dom.find('*[data-layer]');
		aLayers.each(function (){
		    $(this).removeAttr('data-layer').removeAttr('data-type');
		});

		var aLi = $dom.find('li.drag-part');
		var fragment = '';
		aLi.each(function (){
			var html = $(this).html();
			var oRow = '<div class="row">' + html + "</div>";
			fragment += oRow;
		});
		fragment += '<link href="'+absUrl + '/cmskj/css/drag/css/' + 'layoutBuilder.css" type="text/css" rel="stylesheet">';
		fragment += '<link href="'+absUrl + '/cmskj/css/drag/css/' + 'bootstrap.min.css" type="text/css" rel="stylesheet">';
		
		// Append extra refference library
		$.each(extLinks, function (){
            fragment += $(this).prop('outerHTML').toString();
        });
		$.each(extScripts, function (){
		    fragment += $(this).prop('outerHTML').toString();
		});
		
		var fixedWidth = globalWidth ? 'width : ' + globalWidth + ';' : 'width:1024px;';
		fragment = '<div style="margin:0 auto;'+fixedWidth+'">'+fragment+'</div><div style="clear:both;"></div>';
		return fragment;
	}

	/**
	 * [initPublish Binding publish event to Publish Button]
	 * @return {[void]}
	 * 	
	 * comment: As the publish action will take 3 steps, so to devide and conquer it
	 */
	function initPublish(){
		$('#btn-publish').on('click', function (){
			var html = trimEmptyDivs();
			doPublish(html);
		});
	}

	function trimEmptyDivs () {
		var oWrapper = $('#main-wrapper');
		if(globalWidth){
		    oWrapper.attr('data-cached-width', globalWidth);
		}
		oWrapper.find('div[data-emptydiv=true]').remove();
		oWrapper.find('.highlight').removeClass('highlight');
		oWrapper.find('.widgetHighLight').removeClass('widgetHighLight');
		return oWrapper.prop('outerHTML');
	}
	/**
	 * [initWidgetRadioButton description]
	 * @return {[type]}
	 *
	 * comment : Change widget's contents automatically when user click the radio buttons under widget menu
	 */
	function initWidgetRadioButton(){
		var oTab = $('.widget-items-tab');
		var oWidget = $('#widget-tab-container').parent();
		var aRadios = oTab.find('input[type=radio]');
		var aWidgetContents = oWidget.find('.widget-content');
		aRadios.each(function (index){
		    $(this).on('click',function (){
	            aRadios.removeAttr('checked');
	            aRadios.eq(index).prop('checked', 'checked');
	            aWidgetContents.hide();
	            aWidgetContents.eq(index).fadeIn();
	        });
		});
		aRadios.eq(0).trigger('click');
	}

	/**
	 * [renderConfigPanel description]
	 * @param  {[string]}
	 * @return {[type]}
	 *
	 * comment : 
	 */
	function renderConfigPanel(html){
		var oModal = $('#configModal');
		var oBody = oModal.find('.modal-body');
		var oFooter = oModal.find('.modal-footer');
		oBody.html(html['body']);
		if(html['footer']){
		    oFooter.html(html['footer']);
		    oFooter.find('.btn-primary').on('click',function (){
		    	html['buttonFn']['fnOK']();
		    });
	        oFooter.find('.btn-default').on('click',html['buttonFn']['fnCancel']);
		}
		
		// Has render event
		if (typeof html['onRenderReady'] != 'undefined') {
			if ($.isFunction(html['onRenderReady']))
				html['onRenderReady']();
			oBody.find('button.upload').on('click', html['buttonFn']['fnUpload']);
		}
		
		oModal.modal('show');
	}


	//This panel is shown for layout configuration

	function renderLayoutConfigPanel(html){
		var oModal = $('#configModal');
		var oBody = oModal.find('.modal-body');
		var oFooter = oModal.find('.modal-footer');
		oBody.html(html['body']);
		oFooter.html(html['footer']);
		
		if (typeof html['onRenderReady'] != 'undefined') {
		    if ($.isFunction(html['onRenderReady']))
                html['onRenderReady']();
		}
		oFooter.find('.btn-primary').on('click',html['buttonFn']['fnOK']);
		oFooter.find('.btn-default').on('click',html['buttonFn']['fnCancel']);
		oModal.modal('show');
	}

	/**
	 * [initMainWrapper description]
	 * @return {[type]} [description]
	 *
	 * comment : 
	 * 			After Ajaxing template from remote server, 
	 * 			init all the widget and layout events
	 */
	function initMainWrapper(callback){
		var draggedList = $('#dragged-list');
		draggedList.dragsort();
		
		/* highlight all widgets */
		var oWrapper = $('#main-wrapper');
		oWrapper.find('*[operable]').each(function (){
		    $(this).addClass('.widgetHighlight');
		});
		
		$('.layout-container').smartMenu(menuData);
		$('.layout-container').find('*[operable]').each(function (){
		    $(this).smartMenu(menuData);
		});
		
		var $nav = $('.widget-nav-list');
        if ($nav.length) {
            if ($nav.hasClass('multi-nav')) {
                $nav.johnDraggable(draggableData);
                var parentUl = $nav.children('ul.nav-list');
                var parentAl =  parentUl.children('li.nav-list-item');
                parentAl.each(function (){
                    var aNavList = $(this).children('ul.nav-list');
                    aNavList.hide();
                    aNavList.css({
                        width : 100*aNavList.length +'%'
                    });
                    
                    parentAl.smartMenu(menuData);
                });
                parentAl.on('mouseover', navigatorHoverFn);
                
            } else {
                $nav.johnDraggable(draggableData);
            }
        }
        
        // topic slider
        var $tpSlider = $('.topic-slider');
        if ($tpSlider.length) {
            $tpSlider.each(function (){
                var $dom = $(this);
                var oTopicList = $dom.find('ul.topic-list'),
                    aTopicListItem = oTopicList.children('li'),
                    oBtnList = $dom.find('ul.btn-list'),
                    aBtnListItem = oBtnList.find('li.btn-list-item');
                
                aBtnListItem.on('mouseover', function (){
                    var idx = $(this).index();
                    aBtnListItem.removeClass('active');
                    $(this).addClass('active');
                    aTopicListItem.css({
                        'z-index' : -1
                    });
                    aTopicListItem.eq(idx).css({
                        'z-index' : 0
                    });
                });
                $dom.johnDraggable(draggableData);
            });
        };
		
		$(document).on('click',function (){
		    $('.layout-cell').removeClass('highlight');
			$.smartMenu.hide();
			$('.widgetHighLight').removeClass('widgetHighLight');
		});
		$(window).on('scroll', function (){
			$.smartMenu.hide();
		});
		initWrapperDraggable();
		if (callback && $.isFunction(callback)) {
		    callback();
        }
	}

	
	//=================================================================
	//
	// Mask Controll Start
	// 
	// comment : This part is a tiny mask util for simulate a static 
	// 			 modal, witch should be combined with some DIY windows.
	//
	//
	//
	//=================================================================
	function mask (){
		var $body = $(document.body);
		var $win = $(window);
		if (!$body.find('.mask').length) {
			$body.append($('<div class="mask"></div>'));
		}
		var m = maxMask();
		if (!m.data('data-resize')) {
		    $win.on('resize', function (){
				throttle(m.get(0),maxMask());
			});
			m.data('data-resize', true);
		}
	}

	function maxMask(){
		var $doc = $(document);
		var $body = $(document.body);
		var oMask = $body.find('.mask');
		oMask.css({
			"z-index" : 9999,
			"background-color" : '#000',
			"position" : "absolute",
			"left" : 0, "top" : 0,
			"width" : $doc.width(),
			"height" : $doc.height()
		}).fadeIn();

		var oPanel = $('#sourceCodePanel');
		if (oPanel.length) {
			var w = ($(window).width() - oPanel.width())/2;
			var h = ($(window).height() - oPanel.height())/2;

			w = w>10 ? w : 10;
			h = h>10 ? h : 10;
			oPanel.css({
				left : w,
				top : h
			});
		}
		return oMask;
	}

	function unmask(){
		var $doc = $(document);
		var oMask = $doc.find('.mask');
		if (oMask.length) {
			oMask.css({
				'z-index' : -1
			}).hide();
		}
	}

	function throttle (obj, fn){
		clearTimeout(obj.timeoutId);
		obj.timeoutId = setTimeout(function (){
			if ($.isFunction(fn)) {
				fn();
			}
		},50);
	}

	//=================================================================
	//
	// Mask Controll End
	// 
	//=================================================================

	/*
	*
	*	This allows user to drag and drop an explicit widget into layout-template,
	*	The callback function (fnDragEnd) points to a target widget witch has alreay been drop into a layout container	
	*
	*/
	var draggableData = {
        context : 'body',
        targetWrapperClass : '.wrapper',
        targetClass : '.layout-cell',
        fnDragEnd : function (oTargetWidget){
            //request html and append;
            //var html = $(this).html();

        }
	};
	function initDragWidgets(){
		var ctx = $('.widget-container');
		var aWidgets = ctx.find('.widget-list-item');
		aWidgets.each(function (){
			$(this).johnDraggable(draggableData);
		});
	};

	function resetDragWidgets(){
		var ctx = $('.widget-container');
		var aWidgets = ctx.find('.widget-list-item');
		aWidgets.each(function (){
			$(this).johnDraggable('destroy');
		});
		initDragWidgets();
		initWrapperDraggable();
	}

	function initDragLayouts(){
	    var ctx = $(".layout-container");
	    var aLayouts = ctx.find('.layout-list-item');
	    aLayouts.johnDraggable('destroy');
	    aLayouts.each(function (){
            $(this).johnDraggable(draggableData);
        });
	}
	
	
	//=================================================================================
	//
	//	There are some util functions
	//
	//==================================================================================

	
	function toCamelCase(str){
		return str.replace(/\-(\w)/g, function(all, letter){return letter.toUpperCase();});
	}

	function camel2HB(str){
		return str.replace(/([A-Z])/g,"-$1").toLowerCase();
	}

	window.debug = false;
	function log(k,v){
		if (window.debug && console && console.log) {
			k && (v ? console.log(k, v) : console.log(k));
		}
	}
	function dir(o){
		if (window.debug && console && console.dir) {
			console.dir(o);
		}
	}
	
	$(function (){
	    /**
	     * [description]
	     * @param  {[type]} ){      initModules();  } [description]
	     * @return {[type]}                        [description]
	     *
	     * comment : 
	     *          Global Main Entry
	     */
	    // $.holdReady(false);
		
	    initModules(window.gUrl);
	});